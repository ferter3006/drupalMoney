<?php

/**
 * @file
 * Primary module hooks for MoneyLink Navigation module.
 */

/**
 * Implements hook_preprocess_page().
 */
function moneylink_navigation_preprocess_page(&$variables) {
  // Agregar CSS personalizado para el menú
  if (\Drupal::currentUser()->isAuthenticated()) {
    $variables['#attached']['html_head'][] = [
      [
        '#tag' => 'style',
        '#value' => '
          .site-header .menu--main .menu__item {
            margin-right: 1.5rem;
          }
          .site-header .menu--main .menu__item:last-child {
            margin-right: 0;
          }
        ',
      ],
      'moneylink_menu_spacing'
    ];
  }
}

/**
 * Implements hook_preprocess_menu().
 */
function moneylink_navigation_preprocess_menu(&$variables) {
  // Solo modificar el menú principal
  if ($variables['menu_name'] === 'main') {
    // Primero, eliminar cualquier enlace "Inicio" existente de Drupal
    foreach ($variables['items'] as $key => $item) {
      if (isset($item['title']) && (
          $item['title'] == 'Inicio' || 
          $item['title'] == 'Home' ||
          (isset($item['url']) && $item['url']->toString() == '/')
        )) {
        unset($variables['items'][$key]);
      }
    }
    
    // Verificar si el usuario está autenticado en MoneyLink
    $store_service = \Drupal::service('moneylink_store.service');
    $user_data = $store_service->getUserData();
    $token = $store_service->getAuthToken();
    
    if ($user_data && $token) {
      // Usuario logueado - agregar enlaces de navegación completa
      $moneylink_items = [
        'home' => [
          'title' => 'Inicio',
          'url' => \Drupal\Core\Url::fromRoute('moneylink_home.home'),
          'weight' => 5,
        ],
        'userpanel' => [
          'title' => 'Panel de Usuario',
          'url' => \Drupal\Core\Url::fromRoute('moneylink_userpanel'),
          'weight' => 10,
        ],
        'salas' => [
          'title' => 'Mis Salas', 
          'url' => \Drupal\Core\Url::fromRoute('moneylink_salas.content'),
          'weight' => 11,
        ],
        'perfil' => [
          'title' => 'Mi Perfil',
          'url' => \Drupal\Core\Url::fromRoute('moneylink_perfil.content'),
          'weight' => 12,
        ],
        'logout' => [
          'title' => 'Cerrar Sesión',
          'url' => \Drupal\Core\Url::fromRoute('moneylink_logout'),
          'weight' => 13,
        ],
      ];
    } else {
      // Usuario NO logueado - mostrar inicio y login
      $moneylink_items = [
        'home' => [
          'title' => 'Inicio',
          'url' => \Drupal\Core\Url::fromRoute('moneylink_home.home'),
          'weight' => 5,
        ],
        'login' => [
          'title' => 'Iniciar Sesión',
          'url' => \Drupal\Core\Url::fromRoute('ml.login'),
          'weight' => 10,
        ],
      ];
    }
    
    // Agregar los elementos al menú existente con estructura completa
    foreach ($moneylink_items as $key => $item) {
      // Verificar si el usuario puede acceder a esta ruta
      if ($item['url']->access()) {
        // Preparar atributos especiales para logout
        $attributes = new \Drupal\Core\Template\Attribute();
        if ($key === 'logout') {
          $attributes->setAttribute('onclick', "return confirm('¿Estás seguro de que quieres cerrar sesión?');");
        }
        
        $variables['items'][$key] = [
          'title' => $item['title'],
          'url' => $item['url'],
          'weight' => $item['weight'],
          'attributes' => $attributes,
          'below' => [],
          'in_active_trail' => FALSE,
          'is_expanded' => FALSE,
          'is_collapsed' => FALSE,
          'original_link' => (object) [
            'enabled' => 1,
            'title' => $item['title'],
            'menu_name' => 'main',
            'weight' => $item['weight'],
          ]
        ];
      }
    }
    
    // Ordenar los elementos por peso
    uasort($variables['items'], function($a, $b) {
      $a_weight = $a['weight'] ?? 0;
      $b_weight = $b['weight'] ?? 0;
      return $a_weight <=> $b_weight;
    });
    
    // Agregar contextos de cache para que el menú se actualice correctamente
    $variables['#cache']['contexts'][] = 'user';
    $variables['#cache']['contexts'][] = 'session';
  }
}